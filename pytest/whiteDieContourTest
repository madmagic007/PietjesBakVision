import cv2
import numpy as np
from collections import deque

def nothing(x):
    pass

def getVal(name):
    return cv2.getTrackbarPos(str(name), "controls")

cv2.namedWindow("controls")
cv2.createTrackbar("0", "controls", 19, 30, nothing) # blur
cv2.createTrackbar("1", "controls", 0, 255, nothing) # cLow
cv2.createTrackbar("2", "controls", 60, 255, nothing) # cHigh
cv2.createTrackbar("3", "controls", 7, 30, nothing) # dilate/openclose kernel value
cv2.createTrackbar("4", "controls", 30, 50, nothing) # blackhat kernel value
cv2.createTrackbar("5", "controls", 70, 255, nothing) # blackhat thresh val

webCam = cv2.VideoCapture(1)
webCam.set(cv2.CAP_PROP_FOURCC, cv2.VideoWriter_fourcc('M','J','P','G'))
webCam.set(cv2.CAP_PROP_FRAME_WIDTH, 3840)
webCam.set(cv2.CAP_PROP_FRAME_HEIGHT, 2160)

def show(title, img):
    scaled = cv2.resize(img, None, fx=0.3, fy=0.3, interpolation=cv2.INTER_AREA)
    cv2.imshow(title, scaled)

edge_buffer = deque(maxlen=10)

def getFilledContours(blurred):
    edges = cv2.Canny(blurred, getVal(1), getVal(2))

    k = getVal(3)
    kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (k, k))
    
    edges = cv2.dilate(edges, kernel, iterations=2)
    edges = cv2.morphologyEx(edges, cv2.MORPH_CLOSE, kernel, iterations=2)
    edges = cv2.morphologyEx(edges, cv2.MORPH_OPEN, kernel, iterations=2)

    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    filled = np.zeros_like(edges)
    cv2.drawContours(filled, contours, -1, 255, thickness=cv2.FILLED)

    edge_buffer.append(filled)
    for e in edge_buffer:
        filled = cv2.bitwise_or(filled, e)

    show("filled", filled)

    contours, _ = cv2.findContours(filled, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    return contours

def getBlackHat(blurred):
    k = getVal(4)
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (k, k))

    bh = cv2.morphologyEx(blurred, cv2.MORPH_BLACKHAT, kernel)
    bh = cv2.normalize(bh, None, 0, 255, cv2.NORM_MINMAX)
    _, bh = cv2.threshold(bh, getVal(5), 255, cv2.THRESH_BINARY)
    show("bh", bh)

    return bh

def filterContours(filledContours, pipContours):
    results = []

    for filledContour in filledContours:
        area = cv2.contourArea(filledContour)
        if area < 20000: 
            continue 

        for pipContour in pipContours:
            x, y = pipContour[0][0]
            point = (int(x), int(y))
            if cv2.pointPolygonTest(filledContour, point, False) >= 0:
                results.append(filledContour)
                break

    return results

while True:
    _, bgr = webCam.read()
    # show("cam", bgr)

    blurVal = getVal(0)
    if blurVal %2 == 0:
        blurVal += 1

    gray = cv2.cvtColor(bgr, cv2.COLOR_BGR2GRAY)
    blur = cv2.GaussianBlur(gray, (blurVal, blurVal), 0)

    filledContours = getFilledContours(blur)
    bh = getBlackHat(blur)
    pipContours, _ = cv2.findContours(bh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    filteredContours = filterContours(filledContours, pipContours)
    
    cv2.drawContours(bgr, pipContours, -1, (255, 0, 0), 2)
    cv2.drawContours(bgr, filteredContours, -1, (0, 0, 255), 2)

    show("conts", bgr)

    res = cv2.waitKey(1)
    if res & 0xFF == ord('q'):
        break